@{
    ViewData["Title"] = "Confirmar Punto de Recolección";
}

<div class="container">
    <h2>Confirmar Punto de Recolección</h2>
    
    <div id="punto-info" class="punto-info mb-4">
        <!-- Aquí se mostrará la información del punto seleccionado -->
    </div>
    
    <div class="text-center mt-4">
        <button id="btn-confirmar" class="btn btn-primary">Confirmar pedido</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Recuperar el punto seleccionado del localStorage
        const puntoSeleccionado = JSON.parse(localStorage.getItem('puntoSeleccionado'));
        
        if (!puntoSeleccionado) {
            window.location.href = '/Recoleccion/Seleccionar';
            return;
        }
        
        // Mostrar información del punto
        const puntoInfo = document.getElementById('punto-info');
        puntoInfo.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">${puntoSeleccionado.name}</h5>
                    <p class="card-text">${puntoSeleccionado.address}</p>
                    <p class="card-text text-success">Este es el punto de recolección que has seleccionado.</p>
                </div>
            </div>
        `;
        
        // Configurar el evento del botón de confirmar
        document.getElementById('btn-confirmar').addEventListener('click', function() {
            // Verificar que haya un punto seleccionado
            if (!puntoSeleccionado) {
                alert('Selecciona primero un punto de recolección');
                return;
            }
            
            // Obtener los productos del carrito
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            // Verificar que haya productos en el carrito
            if (cart.length === 0) {
                alert('No hay productos en el carrito');
                return;
            }
            
            // Enviar la información al servidor
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cart: cart,
                    collectionPointId: puntoSeleccionado.id
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al crear el pedido');
                }
                return response.json();
            })
            .then(data => {
                // Limpiar el carrito y el punto seleccionado
                localStorage.removeItem('cart');
                localStorage.removeItem('puntoSeleccionado');
                
                // Mostrar mensaje de éxito
                alert('Pedido confirmado exitosamente');
                
                // Redireccionar a la página de Resumen con el ID del pedido
                window.location.href = `/Pedidos/Resumen/${data.id}`;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurrió un error al procesar tu pedido. Por favor, intenta nuevamente.');
            });
        });
    });
</script>